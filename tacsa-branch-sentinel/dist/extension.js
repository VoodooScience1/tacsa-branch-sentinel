"use strict";var z=Object.create;var b=Object.defineProperty;var Q=Object.getOwnPropertyDescriptor;var V=Object.getOwnPropertyNames;var J=Object.getPrototypeOf,X=Object.prototype.hasOwnProperty;var Z=(e,n)=>{for(var t in n)b(e,t,{get:n[t],enumerable:!0})},W=(e,n,t,r)=>{if(n&&typeof n=="object"||typeof n=="function")for(let s of V(n))!X.call(e,s)&&s!==t&&b(e,s,{get:()=>n[s],enumerable:!(r=Q(n,s))||r.enumerable});return e};var ee=(e,n,t)=>(t=e!=null?z(J(e)):{},W(n||!e||!e.__esModule?b(t,"default",{value:e,enumerable:!0}):t,e)),ne=e=>W(b({},"__esModule",{value:!0}),e);var pe={};Z(pe,{activate:()=>le,deactivate:()=>fe});module.exports=ne(pe);var o=ee(require("vscode")),U="tacsaBranchSentinel.enableStatusBarTint",F="tacsaBranchSentinel.pinnedRepos",Y="tacsaBranchSentinel.primaryRepo";function u(){return o.workspace.getConfiguration()}function te(){return u().get(U,!0)}async function H(e){await u().update(U,e,o.ConfigurationTarget.Workspace)}function k(){return u().get("tacsaBranchSentinel.repoRules")??{}}function p(e,n){return String(u().get(`tacsaBranchSentinel.${e}`,n)).trim()}function m(e){return`$(${e})`}function T(e){return Array.from(new Set(e))}function E(){let e=u().get(F,[]);return Array.isArray(e)?e.filter(Boolean):[]}function M(){return String(u().get(Y,"")).trim()}async function R(e){await u().update(Y,e,o.ConfigurationTarget.Workspace)}function ae(e,n=10){return e.length<=n?e:e.slice(0,n)+"\u2026"}function oe(e,n){let t=e.toLowerCase(),r=n.toLowerCase().trim();if(!r)return!1;if(!r.includes("*"))return t===r;let s=r.split("*").filter(Boolean);if(s.length===0)return!0;let c=0;for(let a of s){let i=t.indexOf(a,c);if(i===-1)return!1;c=i+a.length}return!0}function g(e,n){return!e||!n||n.length===0?!1:n.some(t=>oe(e,t))}function G(e,n){let t=k()[e];return!t||!n?"default":g(n,t.prod)||g(n,t.dev)||g(n,t.neutral)?"repo-rule":"default"}function $(e){if(!e.hasRemote)return"local";let n=(e.branch??"").toLowerCase(),t=k()[e.name];if(t&&e.branch){if(g(e.branch,t.prod))return"prod";if(g(e.branch,t.dev))return"dev";if(g(e.branch,t.neutral))return"neutral"}return n==="master"||n==="main"?"prod":n==="dev"?"dev":"unknown"}function I(e){return m(e==="prod"?p("iconProd","shield"):e==="dev"?p("iconDev","tools"):e==="unknown"?"question":e==="local"?"lock":p("iconNeutral","git-branch"))}async function O(e){let n=u().get("workbench.colorCustomizations")??{},t={...n};e==="prod"?(t["statusBar.background"]="#7a1111",t["statusBar.foreground"]="#ffffff",t["statusBar.debuggingBackground"]="#7a1111"):e==="dev"?(t["statusBar.background"]="#0f6b2f",t["statusBar.foreground"]="#ffffff",t["statusBar.debuggingBackground"]="#0f6b2f"):e==="unknown"?(t["statusBar.background"]="#b36b00",t["statusBar.foreground"]="#ffffff",t["statusBar.debuggingBackground"]="#b36b00"):e==="local"?(t["statusBar.background"]="#5b2b82",t["statusBar.foreground"]="#ffffff",t["statusBar.debuggingBackground"]="#5b2b82"):(delete t["statusBar.background"],delete t["statusBar.foreground"],delete t["statusBar.debuggingBackground"]),JSON.stringify(n)!==JSON.stringify(t)&&await u().update("workbench.colorCustomizations",t,o.ConfigurationTarget.Workspace)}function re(e){let n=e.path.split("/").filter(Boolean);return n[n.length-1]??"repo"}async function se(){let e=o.extensions.getExtension("vscode.git");if(e)return await e.activate(),e.exports.getAPI(1)}async function h(){let e=await se();return e?e.repositories.map(n=>{let t=re(n.rootUri),r=n.state.HEAD?.name??null,s=n.rootUri.fsPath,c=Array.isArray(n.state.remotes)&&n.state.remotes.length>0;return{name:t,branch:r,path:s,hasRemote:c}}):[]}function y(e){let t=o.window.activeTextEditor?.document?.uri?.fsPath??"";return e.find(r=>t.startsWith(r.path))??e[0]}function ie(e){let n=E(),t=M();if(t){let r=e.find(s=>s.name===t);if(r)return r}if(n.length>0){let r=e.find(s=>s.name===n[0]);if(r)return r}return y(e)}async function D(e,n,t){let r=k(),s=r[n]??{prod:[],dev:[],neutral:[]},c=t.trim(),a={prod:s.prod??[],dev:s.dev??[],neutral:s.neutral??[]};a.prod=(a.prod??[]).filter(i=>i.toLowerCase()!==c.toLowerCase()),a.dev=(a.dev??[]).filter(i=>i.toLowerCase()!==c.toLowerCase()),a.neutral=(a.neutral??[]).filter(i=>i.toLowerCase()!==c.toLowerCase()),e==="prod"?a.prod=T([...a.prod??[],c]):e==="dev"?a.dev=T([...a.dev??[],c]):a.neutral=T([...a.neutral??[],c]),r[n]=a,await u().update("tacsaBranchSentinel.repoRules",r,o.ConfigurationTarget.Workspace)}async function P(){let e=await h();if(e.length===0)return null;let n=y(e),t=n.branch??"";return t?{repo:n,branch:t}:(o.window.showWarningMessage("TacSA: No branch detected (detached HEAD?)."),null)}async function ce(){let e=["shield","warning","tools","rocket","bug","beaker","flask","check","git-branch","circle-large-outline","circle-slash","zap","wrench","lock","question"],n=async(l,f)=>o.window.showQuickPick(e,{title:`Pick icon for ${l}`,placeHolder:`Current: ${f}`}),t=p("iconProd","shield"),r=p("iconDev","tools"),s=p("iconNeutral","git-branch"),c=await n("PROD",t);if(!c)return;let a=await n("DEV",r);if(!a)return;let i=await n("NEUTRAL",s);i&&(await u().update("tacsaBranchSentinel.iconProd",c,o.ConfigurationTarget.Workspace),await u().update("tacsaBranchSentinel.iconDev",a,o.ConfigurationTarget.Workspace),await u().update("tacsaBranchSentinel.iconNeutral",i,o.ConfigurationTarget.Workspace),o.window.showInformationMessage("TacSA: Icons updated (workspace)."))}async function ue(){let e=await h();if(e.length===0)return;let n=y(e),t=k(),r=t[n.name]??{prod:[],dev:[],neutral:[]},s=async(f,w)=>o.window.showInputBox({title:`Repo rules for ${n.name}`,prompt:`${f} branches (comma-separated, supports * wildcards)`,value:w.join(", ")}),c=await s("PROD",r.prod??[]);if(c===void 0)return;let a=await s("DEV",r.dev??[]);if(a===void 0)return;let i=await s("NEUTRAL",r.neutral??[]);if(i===void 0)return;let l=f=>f.split(",").map(w=>w.trim()).filter(Boolean);t[n.name]={prod:l(c),dev:l(a),neutral:l(i)},await u().update("tacsaBranchSentinel.repoRules",t,o.ConfigurationTarget.Workspace),o.window.showInformationMessage(`TacSA: Repo rules saved for ${n.name} (workspace).`)}async function de(){let e=await h();if(e.length===0){o.window.showInformationMessage("No Git repositories detected.");return}let n=new Set(E()),t=await o.window.showQuickPick(e.map(i=>({label:i.name,description:i.branch??"DETACHED",picked:n.has(i.name)})),{canPickMany:!0,placeHolder:"Select repos to pin in the Branch Sentinel display"});if(!t)return;let r=t.map(i=>i.label);if(await u().update(F,r,o.ConfigurationTarget.Workspace),r.length===0){await R(""),o.window.showInformationMessage("TacSA: pinned repos cleared.");return}let s=M(),c=s&&r.includes(s)&&s||r[0];if(r.length===1){await R(r[0]),o.window.showInformationMessage(`TacSA: pinned 1 repo (primary = ${r[0]}).`);return}let a=await o.window.showQuickPick(r,{placeHolder:`Pick the repo Sentinel should DISPLAY (primary). Current: ${c}`});if(!a){await R(c),o.window.showInformationMessage(`TacSA: pinned ${r.length} repo(s) (primary = ${c}).`);return}await R(a),o.window.showInformationMessage(`TacSA: pinned ${r.length} repo(s) (primary = ${a}).`)}function le(e){let n=o.window.createStatusBarItem(o.StatusBarAlignment.Left,1e3);n.name="TacSA Branch Sentinel",n.command="tacsa-branch-sentinel.pickPinnedRepos",n.show();let t=null,r=null,s=async()=>{let a=await h();if(a.length===0){n.text="\u2387 No Git repo",n.tooltip="TacSA Branch Sentinel: No Git repositories detected.";return}let i=y(a),l=$(i),f=ie(a),w=$(f);te()?l!==t&&(t=l,await O(l)):t!=="neutral"&&(t="neutral",await O("neutral"));let x=`${i.name}:${i.branch??"DETACHED"}`;l==="prod"&&r!==x&&(r=x,o.window.showWarningMessage(`You are on ${i.name} \u2192 ${i.branch}. Be careful.`,"OK"));let _=i.branch??"DETACHED",K=G(i.name,i.branch)==="repo-rule"?" (rule)":"",j=I(l),N=E(),v=N.length,B="";if(v>0){let d=v>1?` +${v-1}`:"",S=v>1?ae(f.name):f.name,A=I(w),C=f.branch??"DETACHED";B=` | + ${A} ${S} \u2022 ${C}${d}`}else{let d=a.length-1;B=d>0?` | +${d}`:""}n.text=`${j} ${i.name} \u2022 ${_}${K}${B}`,n.tooltip=a.map(d=>{let S=$(d),A=G(d.name,d.branch)==="repo-rule"?"rule":"default",C=d.hasRemote?"remote":"local-only",L=N.includes(d.name)?d.name===M()?"PRIMARY":"pinned":"",q=L?`, ${L}`:"";return`${I(S)} ${d.name}: ${d.branch??"DETACHED"} [${A}, ${C}${q}]`}).join(`
`)};e.subscriptions.push(o.commands.registerCommand("tacsa-branch-sentinel.showDetails",async()=>{let a=await h();if(a.length===0){o.window.showInformationMessage("No Git repositories detected.");return}o.window.showInformationMessage(a.map(i=>`${i.name}: ${i.branch??"DETACHED"}`).join(" \u2022 "))}),o.commands.registerCommand("tacsa-branch-sentinel.enableTint",async()=>{await H(!0),t=null,await s(),o.window.showInformationMessage("TacSA: Status bar tint ENABLED (workspace).")}),o.commands.registerCommand("tacsa-branch-sentinel.disableTint",async()=>{await H(!1),t=null,await s(),o.window.showInformationMessage("TacSA: Status bar tint DISABLED (workspace).")}),o.commands.registerCommand("tacsa-branch-sentinel.pickIcons",ce),o.commands.registerCommand("tacsa-branch-sentinel.editRepoRules",ue),o.commands.registerCommand("tacsa-branch-sentinel.pickPinnedRepos",async()=>{await de(),await s()}),o.commands.registerCommand("tacsa-branch-sentinel.markProd",async()=>{let a=await P();a&&(await D("prod",a.repo.name,a.branch),o.window.showInformationMessage(`TacSA: ${a.repo.name}/${a.branch} marked PROD.`),await s())}),o.commands.registerCommand("tacsa-branch-sentinel.markDev",async()=>{let a=await P();a&&(await D("dev",a.repo.name,a.branch),o.window.showInformationMessage(`TacSA: ${a.repo.name}/${a.branch} marked DEV.`),await s())}),o.commands.registerCommand("tacsa-branch-sentinel.markNeutral",async()=>{let a=await P();a&&(await D("neutral",a.repo.name,a.branch),o.window.showInformationMessage(`TacSA: ${a.repo.name}/${a.branch} marked NEUTRAL.`),await s())}));let c=setInterval(s,2e3);e.subscriptions.push({dispose:()=>clearInterval(c)}),o.window.onDidChangeActiveTextEditor(s,null,e.subscriptions),o.window.onDidChangeWindowState(s,null,e.subscriptions),s()}function fe(){}0&&(module.exports={activate,deactivate});
