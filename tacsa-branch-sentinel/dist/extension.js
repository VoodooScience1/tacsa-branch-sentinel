"use strict";var W=Object.create;var v=Object.defineProperty;var H=Object.getOwnPropertyDescriptor;var O=Object.getOwnPropertyNames;var U=Object.getPrototypeOf,G=Object.prototype.hasOwnProperty;var j=(e,t)=>{for(var o in t)v(e,o,{get:t[o],enumerable:!0})},E=(e,t,o,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of O(t))!G.call(e,r)&&r!==o&&v(e,r,{get:()=>t[r],enumerable:!(s=H(t,r))||s.enumerable});return e};var F=(e,t,o)=>(o=e!=null?W(U(e)):{},E(t||!e||!e.__esModule?v(o,"default",{value:e,enumerable:!0}):o,e)),K=e=>E(v({},"__esModule",{value:!0}),e);var Z={};j(Z,{activate:()=>Q,deactivate:()=>X});module.exports=K(Z);var a=F(require("vscode")),P="tacsaBranchSentinel.enableStatusBarTint";function l(){return a.workspace.getConfiguration()}function z(){return l().get(P,!0)}async function y(e){await l().update(P,e,a.ConfigurationTarget.Workspace)}function R(){return l().get("tacsaBranchSentinel.repoRules")??{}}function m(e,t){return String(l().get(`tacsaBranchSentinel.${e}`,t)).trim()}function D(e){return`$(${e})`}function k(e){return Array.from(new Set(e))}async function C(e,t,o){let s=R(),r=s[t]??{prod:[],dev:[],neutral:[]},i=o.trim(),n={prod:r.prod??[],dev:r.dev??[],neutral:r.neutral??[]};n.prod=(n.prod??[]).filter(c=>c.toLowerCase()!==i.toLowerCase()),n.dev=(n.dev??[]).filter(c=>c.toLowerCase()!==i.toLowerCase()),n.neutral=(n.neutral??[]).filter(c=>c.toLowerCase()!==i.toLowerCase()),e==="prod"?n.prod=k([...n.prod??[],i]):e==="dev"?n.dev=k([...n.dev??[],i]):n.neutral=k([...n.neutral??[],i]),s[t]=n,await l().update("tacsaBranchSentinel.repoRules",s,a.ConfigurationTarget.Workspace)}async function T(){let e=await b();if(e.length===0)return null;let o=a.window.activeTextEditor?.document?.uri?.fsPath??"",s=e.find(i=>o.startsWith(i.path))??e[0],r=s.branch??"";return r?{repo:s,branch:r}:(a.window.showWarningMessage("TacSA: No branch detected (detached HEAD?)."),null)}function I(e,t){let o=R()[e];return!o||!t?"default":h(t,o.prod)||h(t,o.dev)||h(t,o.neutral)?"repo-rule":"default"}function V(e,t){let o=e.toLowerCase(),s=t.toLowerCase().trim();if(!s)return!1;if(!s.includes("*"))return o===s;let r=s.split("*").filter(Boolean);if(r.length===0)return!0;let i=0;for(let n of r){let c=o.indexOf(n,i);if(c===-1)return!1;i=c+n.length}return!0}function h(e,t){return!e||!t||t.length===0?!1:t.some(o=>V(e,o))}function $(e,t){let o=(t??"").toLowerCase(),s=R()[e];if(s&&t){if(h(t,s.prod))return"prod";if(h(t,s.dev))return"dev";if(h(t,s.neutral))return"neutral"}return o==="master"||o==="main"?"prod":o==="dev"?"dev":"neutral"}function B(e){return D(e==="prod"?m("iconProd","shield"):e==="dev"?m("iconDev","tools"):m("iconNeutral","git-branch"))}async function x(e){let t=l().get("workbench.colorCustomizations")??{},o={...t};e==="prod"?(o["statusBar.background"]="#7a1111",o["statusBar.foreground"]="#ffffff",o["statusBar.debuggingBackground"]="#7a1111"):e==="dev"?(o["statusBar.background"]="#0f6b2f",o["statusBar.foreground"]="#ffffff",o["statusBar.debuggingBackground"]="#0f6b2f"):(delete o["statusBar.background"],delete o["statusBar.foreground"],delete o["statusBar.debuggingBackground"]),JSON.stringify(t)!==JSON.stringify(o)&&await l().update("workbench.colorCustomizations",o,a.ConfigurationTarget.Workspace)}function _(e){let t=e.path.split("/").filter(Boolean);return t[t.length-1]??"repo"}async function J(){let e=a.extensions.getExtension("vscode.git");if(e)return await e.activate(),e.exports.getAPI(1)}async function b(){let e=await J();return e?e.repositories.map(t=>{let o=_(t.rootUri),s=t.state.HEAD?.name??null,r=t.rootUri.fsPath;return{name:o,branch:s,path:r}}):[]}async function Y(){let e=["shield","warning","tools","rocket","bug","beaker","flask","check","git-branch","circle-large-outline","circle-slash","zap","wrench"],t=async(g,u)=>a.window.showQuickPick(e,{title:`Pick icon for ${g}`,placeHolder:`Current: ${u}`}),o=m("iconProd","shield"),s=m("iconDev","tools"),r=m("iconNeutral","git-branch"),i=await t("PROD",o);if(!i)return;let n=await t("DEV",s);if(!n)return;let c=await t("NEUTRAL",r);c&&(await l().update("tacsaBranchSentinel.iconProd",i,a.ConfigurationTarget.Workspace),await l().update("tacsaBranchSentinel.iconDev",n,a.ConfigurationTarget.Workspace),await l().update("tacsaBranchSentinel.iconNeutral",c,a.ConfigurationTarget.Workspace),a.window.showInformationMessage("TacSA: Icons updated (workspace)."))}async function q(){let e=await b();if(e.length===0)return;let o=a.window.activeTextEditor?.document?.uri?.fsPath??"",s=e.find(p=>o.startsWith(p.path))??e[0],r=R(),i=r[s.name]??{prod:[],dev:[],neutral:[]},n=async(p,f)=>a.window.showInputBox({title:`Repo rules for ${s.name}`,prompt:`${p} branches (comma-separated)`,value:f.join(", ")}),c=await n("PROD",i.prod??[]);if(c===void 0)return;let g=await n("DEV",i.dev??[]);if(g===void 0)return;let u=await n("NEUTRAL",i.neutral??[]);if(u===void 0)return;let w=p=>p.split(",").map(f=>f.trim()).filter(Boolean);r[s.name]={prod:w(c),dev:w(g),neutral:w(u)},await l().update("tacsaBranchSentinel.repoRules",r,a.ConfigurationTarget.Workspace),a.window.showInformationMessage(`TacSA: Repo rules saved for ${s.name} (workspace).`)}function Q(e){let t=a.window.createStatusBarItem(a.StatusBarAlignment.Left,1e3);t.name="TacSA Branch Sentinel",t.command="tacsa-branch-sentinel.showDetails",t.show();let o=null,s=null,r=async()=>{let n=await b();if(n.length===0){t.text="\u2387 No Git repo",t.tooltip="TacSA Branch Sentinel: No Git repositories detected.";return}let g=a.window.activeTextEditor?.document?.uri?.fsPath??"",u=n.find(d=>g.startsWith(d.path))??n[0],w=n.length>1?` +${n.length-1}`:"",p=u.branch??"DETACHED",f=$(u.name,u.branch),S=B(f);t.text=`${S} ${u.name} \u2022 ${p}${w}`,t.tooltip=n.map(d=>`${B($(d.name,d.branch))} ${d.name}: ${d.branch??"DETACHED"}`).join(`
`);let A=`${u.name}:${u.branch??"DETACHED"}`;f==="prod"&&s!==A&&(s=A,a.window.showWarningMessage(`You are on ${u.name} \u2192 ${u.branch}. Be careful.`,"OK")),z()?f!==o&&(o=f,await x(f)):o!=="neutral"&&(o="neutral",await x("neutral"));let M=I(u.name,u.branch)==="repo-rule"?" (rule)":"";t.text=`${S} ${u.name} \u2022 ${p}${w}${M}`,t.tooltip=n.map(d=>{let L=$(d.name,d.branch),N=I(d.name,d.branch)==="repo-rule"?"rule":"default";return`${B(L)} ${d.name}: ${d.branch??"DETACHED"} [${N}]`}).join(`
`)};e.subscriptions.push(a.commands.registerCommand("tacsa-branch-sentinel.showDetails",async()=>{let n=await b();if(n.length===0){a.window.showInformationMessage("No Git repositories detected.");return}a.window.showInformationMessage(n.map(c=>`${c.name}: ${c.branch??"DETACHED"}`).join(" \u2022 "))}),a.commands.registerCommand("tacsa-branch-sentinel.enableTint",async()=>{await y(!0),o=null,await r(),a.window.showInformationMessage("TacSA: Status bar tint ENABLED (workspace).")}),a.commands.registerCommand("tacsa-branch-sentinel.disableTint",async()=>{await y(!1),o=null,await r(),a.window.showInformationMessage("TacSA: Status bar tint DISABLED (workspace).")}),a.commands.registerCommand("tacsa-branch-sentinel.pickIcons",Y),a.commands.registerCommand("tacsa-branch-sentinel.editRepoRules",q),a.commands.registerCommand("tacsa-branch-sentinel.markProd",async()=>{let n=await T();n&&(await C("prod",n.repo.name,n.branch),a.window.showInformationMessage(`TacSA: ${n.repo.name}/${n.branch} marked PROD.`),await r())}),a.commands.registerCommand("tacsa-branch-sentinel.markDev",async()=>{let n=await T();n&&(await C("dev",n.repo.name,n.branch),a.window.showInformationMessage(`TacSA: ${n.repo.name}/${n.branch} marked DEV.`),await r())}),a.commands.registerCommand("tacsa-branch-sentinel.markNeutral",async()=>{let n=await T();n&&(await C("neutral",n.repo.name,n.branch),a.window.showInformationMessage(`TacSA: ${n.repo.name}/${n.branch} marked NEUTRAL.`),await r())}));let i=setInterval(r,2e3);e.subscriptions.push({dispose:()=>clearInterval(i)}),a.window.onDidChangeActiveTextEditor(r,null,e.subscriptions),a.window.onDidChangeWindowState(r,null,e.subscriptions),r()}function X(){}0&&(module.exports={activate,deactivate});
