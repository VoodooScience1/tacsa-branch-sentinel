"use strict";var F=Object.create;var k=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var j=Object.getPrototypeOf,q=Object.prototype.hasOwnProperty;var z=(e,n)=>{for(var t in n)k(e,t,{get:n[t],enumerable:!0})},E=(e,n,t,s)=>{if(n&&typeof n=="object"||typeof n=="function")for(let r of _(n))!q.call(e,r)&&r!==t&&k(e,r,{get:()=>n[r],enumerable:!(s=K(n,r))||s.enumerable});return e};var V=(e,n,t)=>(t=e!=null?F(j(e)):{},E(n||!e||!e.__esModule?k(t,"default",{value:e,enumerable:!0}):t,e)),J=e=>E(k({},"__esModule",{value:!0}),e);var se={};z(se,{activate:()=>ae,deactivate:()=>re});module.exports=J(se);var a=V(require("vscode")),x="tacsaBranchSentinel.enableStatusBarTint",L="tacsaBranchSentinel.pinnedRepos";function d(){return a.workspace.getConfiguration()}function Q(){return d().get(x,!0)}async function M(e){await d().update(x,e,a.ConfigurationTarget.Workspace)}function R(){return d().get("tacsaBranchSentinel.repoRules")??{}}function g(e,n){return String(d().get(`tacsaBranchSentinel.${e}`,n)).trim()}function m(e){return`$(${e})`}function T(e){return Array.from(new Set(e))}function W(){let e=d().get(L,[]);return Array.isArray(e)?e.filter(Boolean):[]}function Y(e,n=10){return e.length<=n?e:e.slice(0,n)+"\u2026"}function X(e,n){let t=e.toLowerCase(),s=n.toLowerCase().trim();if(!s)return!1;if(!s.includes("*"))return t===s;let r=s.split("*").filter(Boolean);if(r.length===0)return!0;let c=0;for(let o of r){let i=t.indexOf(o,c);if(i===-1)return!1;c=i+o.length}return!0}function p(e,n){return!e||!n||n.length===0?!1:n.some(t=>X(e,t))}function P(e,n){let t=R()[e];return!t||!n?"default":p(n,t.prod)||p(n,t.dev)||p(n,t.neutral)?"repo-rule":"default"}function A(e){if(!e.hasRemote)return"local";let n=(e.branch??"").toLowerCase(),t=R()[e.name];if(t&&e.branch){if(p(e.branch,t.prod))return"prod";if(p(e.branch,t.dev))return"dev";if(p(e.branch,t.neutral))return"neutral"}return n==="master"||n==="main"?"prod":n==="dev"?"dev":"unknown"}function y(e){return m(e==="prod"?g("iconProd","shield"):e==="dev"?g("iconDev","tools"):e==="unknown"?"question":e==="local"?"lock":g("iconNeutral","git-branch"))}async function N(e){let n=d().get("workbench.colorCustomizations")??{},t={...n};e==="prod"?(t["statusBar.background"]="#7a1111",t["statusBar.foreground"]="#ffffff",t["statusBar.debuggingBackground"]="#7a1111"):e==="dev"?(t["statusBar.background"]="#0f6b2f",t["statusBar.foreground"]="#ffffff",t["statusBar.debuggingBackground"]="#0f6b2f"):e==="unknown"?(t["statusBar.background"]="#b36b00",t["statusBar.foreground"]="#ffffff",t["statusBar.debuggingBackground"]="#b36b00"):e==="local"?(t["statusBar.background"]="#5b2b82",t["statusBar.foreground"]="#ffffff",t["statusBar.debuggingBackground"]="#5b2b82"):(delete t["statusBar.background"],delete t["statusBar.foreground"],delete t["statusBar.debuggingBackground"]),JSON.stringify(n)!==JSON.stringify(t)&&await d().update("workbench.colorCustomizations",t,a.ConfigurationTarget.Workspace)}function Z(e){let n=e.path.split("/").filter(Boolean);return n[n.length-1]??"repo"}async function ee(){let e=a.extensions.getExtension("vscode.git");if(e)return await e.activate(),e.exports.getAPI(1)}async function v(){let e=await ee();return e?e.repositories.map(n=>{let t=Z(n.rootUri),s=n.state.HEAD?.name??null,r=n.rootUri.fsPath,c=Array.isArray(n.state.remotes)&&n.state.remotes.length>0;return{name:t,branch:s,path:r,hasRemote:c}}):[]}function I(e){let t=a.window.activeTextEditor?.document?.uri?.fsPath??"";return e.find(s=>t.startsWith(s.path))??e[0]}async function D(e,n,t){let s=R(),r=s[n]??{prod:[],dev:[],neutral:[]},c=t.trim(),o={prod:r.prod??[],dev:r.dev??[],neutral:r.neutral??[]};o.prod=(o.prod??[]).filter(i=>i.toLowerCase()!==c.toLowerCase()),o.dev=(o.dev??[]).filter(i=>i.toLowerCase()!==c.toLowerCase()),o.neutral=(o.neutral??[]).filter(i=>i.toLowerCase()!==c.toLowerCase()),e==="prod"?o.prod=T([...o.prod??[],c]):e==="dev"?o.dev=T([...o.dev??[],c]):o.neutral=T([...o.neutral??[],c]),s[n]=o,await d().update("tacsaBranchSentinel.repoRules",s,a.ConfigurationTarget.Workspace)}async function $(){let e=await v();if(e.length===0)return null;let n=I(e),t=n.branch??"";return t?{repo:n,branch:t}:(a.window.showWarningMessage("TacSA: No branch detected (detached HEAD?)."),null)}async function ne(){let e=["shield","warning","tools","rocket","bug","beaker","flask","check","git-branch","circle-large-outline","circle-slash","zap","wrench","lock","question"],n=async(l,f)=>a.window.showQuickPick(e,{title:`Pick icon for ${l}`,placeHolder:`Current: ${f}`}),t=g("iconProd","shield"),s=g("iconDev","tools"),r=g("iconNeutral","git-branch"),c=await n("PROD",t);if(!c)return;let o=await n("DEV",s);if(!o)return;let i=await n("NEUTRAL",r);i&&(await d().update("tacsaBranchSentinel.iconProd",c,a.ConfigurationTarget.Workspace),await d().update("tacsaBranchSentinel.iconDev",o,a.ConfigurationTarget.Workspace),await d().update("tacsaBranchSentinel.iconNeutral",i,a.ConfigurationTarget.Workspace),a.window.showInformationMessage("TacSA: Icons updated (workspace)."))}async function te(){let e=await v();if(e.length===0)return;let n=I(e),t=R(),s=t[n.name]??{prod:[],dev:[],neutral:[]},r=async(f,b)=>a.window.showInputBox({title:`Repo rules for ${n.name}`,prompt:`${f} branches (comma-separated, supports * wildcards)`,value:b.join(", ")}),c=await r("PROD",s.prod??[]);if(c===void 0)return;let o=await r("DEV",s.dev??[]);if(o===void 0)return;let i=await r("NEUTRAL",s.neutral??[]);if(i===void 0)return;let l=f=>f.split(",").map(b=>b.trim()).filter(Boolean);t[n.name]={prod:l(c),dev:l(o),neutral:l(i)},await d().update("tacsaBranchSentinel.repoRules",t,a.ConfigurationTarget.Workspace),a.window.showInformationMessage(`TacSA: Repo rules saved for ${n.name} (workspace).`)}async function oe(){let e=await v();if(e.length===0){a.window.showInformationMessage("No Git repositories detected.");return}let n=new Set(W()),t=await a.window.showQuickPick(e.map(r=>({label:r.name,description:r.branch??"DETACHED",picked:n.has(r.name)})),{canPickMany:!0,placeHolder:"Select repos to pin in the Branch Sentinel display"});if(!t)return;let s=t.map(r=>r.label);await d().update(L,s,a.ConfigurationTarget.Workspace),a.window.showInformationMessage(`TacSA: pinned ${s.length} repo(s) (workspace).`)}function ae(e){let n=a.window.createStatusBarItem(a.StatusBarAlignment.Left,1e3);n.name="TacSA Branch Sentinel",n.command="tacsa-branch-sentinel.showDetails",n.show();let t=null,s=null,r=async()=>{let o=await v();if(o.length===0){n.text="\u2387 No Git repo",n.tooltip="TacSA Branch Sentinel: No Git repositories detected.";return}let i=I(o),l=A(i);Q()?l!==t&&(t=l,await N(l)):t!=="neutral"&&(t="neutral",await N("neutral"));let f=`${i.name}:${i.branch??"DETACHED"}`;l==="prod"&&s!==f&&(s=f,a.window.showWarningMessage(`You are on ${i.name} \u2192 ${i.branch}. Be careful.`,"OK"));let w=W().map(u=>o.find(h=>h.name===u)).filter(Boolean),H=i.branch??"DETACHED",G=P(i.name,i.branch)==="repo-rule"?" (rule)":"",O=y(l),B="";if(w.length>0){let u=w[0],h=w.length>1?` +${w.length-1}`:"",C=w.length>1?Y(u.name):u.name,S=y(A(u)),U=u.branch??"DETACHED";B=` | + ${S} ${C} \u2022 ${U}${h}`}else{let u=o.length-1;B=u>0?` | +${u}`:""}n.text=`${O} ${i.name} \u2022 ${H}${G}${B}`,n.tooltip=o.map(u=>{let h=A(u),C=P(u.name,u.branch)==="repo-rule"?"rule":"default",S=u.hasRemote?"remote":"local-only";return`${y(h)} ${u.name}: ${u.branch??"DETACHED"} [${C}, ${S}]`}).join(`
`)};e.subscriptions.push(a.commands.registerCommand("tacsa-branch-sentinel.showDetails",async()=>{let o=await v();if(o.length===0){a.window.showInformationMessage("No Git repositories detected.");return}a.window.showInformationMessage(o.map(i=>`${i.name}: ${i.branch??"DETACHED"}`).join(" \u2022 "))}),a.commands.registerCommand("tacsa-branch-sentinel.enableTint",async()=>{await M(!0),t=null,await r(),a.window.showInformationMessage("TacSA: Status bar tint ENABLED (workspace).")}),a.commands.registerCommand("tacsa-branch-sentinel.disableTint",async()=>{await M(!1),t=null,await r(),a.window.showInformationMessage("TacSA: Status bar tint DISABLED (workspace).")}),a.commands.registerCommand("tacsa-branch-sentinel.pickIcons",ne),a.commands.registerCommand("tacsa-branch-sentinel.editRepoRules",te),a.commands.registerCommand("tacsa-branch-sentinel.pickPinnedRepos",oe),a.commands.registerCommand("tacsa-branch-sentinel.markProd",async()=>{let o=await $();o&&(await D("prod",o.repo.name,o.branch),a.window.showInformationMessage(`TacSA: ${o.repo.name}/${o.branch} marked PROD.`),await r())}),a.commands.registerCommand("tacsa-branch-sentinel.markDev",async()=>{let o=await $();o&&(await D("dev",o.repo.name,o.branch),a.window.showInformationMessage(`TacSA: ${o.repo.name}/${o.branch} marked DEV.`),await r())}),a.commands.registerCommand("tacsa-branch-sentinel.markNeutral",async()=>{let o=await $();o&&(await D("neutral",o.repo.name,o.branch),a.window.showInformationMessage(`TacSA: ${o.repo.name}/${o.branch} marked NEUTRAL.`),await r())}));let c=setInterval(r,2e3);e.subscriptions.push({dispose:()=>clearInterval(c)}),a.window.onDidChangeActiveTextEditor(r,null,e.subscriptions),a.window.onDidChangeWindowState(r,null,e.subscriptions),r()}function re(){}0&&(module.exports={activate,deactivate});
