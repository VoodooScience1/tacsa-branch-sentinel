"use strict";var q=Object.create;var b=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var Q=Object.getPrototypeOf,V=Object.prototype.hasOwnProperty;var Y=(e,n)=>{for(var t in n)b(e,t,{get:n[t],enumerable:!0})},M=(e,n,t,s)=>{if(n&&typeof n=="object"||typeof n=="function")for(let a of J(n))!V.call(e,a)&&a!==t&&b(e,a,{get:()=>n[a],enumerable:!(s=z(n,a))||s.enumerable});return e};var X=(e,n,t)=>(t=e!=null?q(Q(e)):{},M(n||!e||!e.__esModule?b(t,"default",{value:e,enumerable:!0}):t,e)),Z=e=>M(b({},"__esModule",{value:!0}),e);var fe={};Y(fe,{activate:()=>de,deactivate:()=>le});module.exports=Z(fe);var o=X(require("vscode")),H="tacsaBranchSentinel.enableStatusBarTint",I="tacsaBranchSentinel.repoRules",F="tacsaBranchSentinel.pinnedRepos";function d(){return o.workspace.getConfiguration()}function g(e){return`$(${e})`}function ee(e,n=10){return e.length<=n?e:e.slice(0,n)+"\u2026"}function R(){return d().get(I)??{}}function G(){let e=d().get(F,[]);return Array.isArray(e)?e.filter(Boolean):[]}function ne(){return d().get(H,!0)}async function N(e){await d().update(H,e,o.ConfigurationTarget.Workspace)}function m(e,n){return String(d().get(`tacsaBranchSentinel.${e}`,n)).trim()}function te(e,n){let t=e.toLowerCase(),s=n.toLowerCase().trim();if(!s)return!1;if(!s.includes("*"))return t===s;let a=s.split("*").filter(Boolean);if(a.length===0)return!0;let c=0;for(let r of a){let i=t.indexOf(r,c);if(i===-1)return!1;c=i+r.length}return!0}function w(e,n){return!e||!n||n.length===0?!1:n.some(t=>te(e,t))}function oe(e,n){let t=R()[e];return!t||!n?"default":w(n,t.prod)||w(n,t.dev)||w(n,t.neutral)?"repo-rule":"default"}function k(e){if(!e.hasRemote)return"local";let n=(e.branch??"").toLowerCase(),t=R()[e.name];if(t&&e.branch){if(w(e.branch,t.prod))return"prod";if(w(e.branch,t.dev))return"dev";if(w(e.branch,t.neutral))return"neutral"}return n==="master"||n==="main"?"prod":n==="dev"?"dev":"unknown"}function L(e){return g(e==="prod"?m("iconProd","shield"):e==="dev"?m("iconDev","tools"):e==="neutral"?m("iconNeutral","git-branch"):e==="local"?"lock":"question")}function re(e){if(e==="prod")return new o.ThemeColor("statusBarItem.errorBackground");if(e==="unknown")return new o.ThemeColor("statusBarItem.warningBackground");if(e==="dev")return new o.ThemeColor("statusBarItem.prominentBackground")}async function W(e){let n=d().get("workbench.colorCustomizations")??{},t={...n};e==="prod"?(t["statusBar.background"]="#7a1111",t["statusBar.foreground"]="#ffffff",t["statusBar.debuggingBackground"]="#7a1111"):e==="dev"?(t["statusBar.background"]="#0f6b2f",t["statusBar.foreground"]="#ffffff",t["statusBar.debuggingBackground"]="#0f6b2f"):e==="unknown"?(t["statusBar.background"]="#b36b00",t["statusBar.foreground"]="#ffffff",t["statusBar.debuggingBackground"]="#b36b00"):e==="local"?(t["statusBar.background"]="#5b2b82",t["statusBar.foreground"]="#ffffff",t["statusBar.debuggingBackground"]="#5b2b82"):(delete t["statusBar.background"],delete t["statusBar.foreground"],delete t["statusBar.debuggingBackground"]),JSON.stringify(n)!==JSON.stringify(t)&&await d().update("workbench.colorCustomizations",t,o.ConfigurationTarget.Workspace)}function ae(e){let n=e.path.split("/").filter(Boolean);return n[n.length-1]??"repo"}async function se(){let e=o.extensions.getExtension("vscode.git");if(e)return await e.activate(),e.exports.getAPI(1)}async function B(){let e=await se();return e?e.repositories.map(n=>{let t=ae(n.rootUri),s=n.state.HEAD?.name??null,a=n.rootUri.fsPath,c=Array.isArray(n.state.remotes)&&n.state.remotes.length>0;return{name:t,branch:s,path:a,hasRemote:c}}):[]}function D(e){let t=o.window.activeTextEditor?.document?.uri?.fsPath??"";return e.find(s=>t.startsWith(s.path))??e[0]}function S(e){return Array.from(new Set(e))}async function A(e,n,t){let s=R(),a=s[n]??{prod:[],dev:[],neutral:[]},c=t.trim(),r={prod:a.prod??[],dev:a.dev??[],neutral:a.neutral??[]};r.prod=(r.prod??[]).filter(i=>i.toLowerCase()!==c.toLowerCase()),r.dev=(r.dev??[]).filter(i=>i.toLowerCase()!==c.toLowerCase()),r.neutral=(r.neutral??[]).filter(i=>i.toLowerCase()!==c.toLowerCase()),e==="prod"?r.prod=S([...r.prod??[],c]):e==="dev"?r.dev=S([...r.dev??[],c]):r.neutral=S([...r.neutral??[],c]),s[n]=r,await d().update(I,s,o.ConfigurationTarget.Workspace)}async function E(){let e=await B();if(e.length===0)return null;let n=D(e),t=n.branch??"";return t?{repo:n,branch:t}:(o.window.showWarningMessage("TacSA: No branch detected (detached HEAD?)."),null)}async function ie(){let e=await B();if(e.length===0){o.window.showInformationMessage("No Git repositories detected.");return}let n=new Set(G()),t=await o.window.showQuickPick(e.map(a=>({label:a.name,description:a.branch??"DETACHED",detail:a.hasRemote?void 0:"local-only (no remote)",picked:n.has(a.name)})),{canPickMany:!0,placeHolder:"Select repos to track (active repo is hidden from this display automatically)"});if(!t)return;let s=t.map(a=>a.label);await d().update(F,s,o.ConfigurationTarget.Workspace),o.window.showInformationMessage(`TacSA: tracking ${s.length} repo(s).`)}async function ce(){let e=["shield","tools","git-branch","beaker","rocket","bug","warning","check","circle-large-outline"],n=async(l,f)=>o.window.showQuickPick(e,{title:`Pick icon for ${l}`,placeHolder:`Current: ${f}`}),t=m("iconProd","shield"),s=m("iconDev","tools"),a=m("iconNeutral","git-branch"),c=await n("PROD",t);if(!c)return;let r=await n("DEV",s);if(!r)return;let i=await n("NEUTRAL",a);i&&(await d().update("tacsaBranchSentinel.iconProd",c,o.ConfigurationTarget.Workspace),await d().update("tacsaBranchSentinel.iconDev",r,o.ConfigurationTarget.Workspace),await d().update("tacsaBranchSentinel.iconNeutral",i,o.ConfigurationTarget.Workspace),o.window.showInformationMessage("TacSA: Icons updated (workspace)."))}async function ue(){let e=await B();if(e.length===0)return;let n=D(e),t=R(),s=t[n.name]??{prod:[],dev:[],neutral:[]},a=async(f,h)=>o.window.showInputBox({title:`Repo rules for ${n.name}`,prompt:`${f} branches (comma-separated, supports * wildcards)`,value:h.join(", ")}),c=await a("PROD",s.prod??[]);if(c===void 0)return;let r=await a("DEV",s.dev??[]);if(r===void 0)return;let i=await a("NEUTRAL",s.neutral??[]);if(i===void 0)return;let l=f=>f.split(",").map(h=>h.trim()).filter(Boolean);t[n.name]={prod:l(c),dev:l(r),neutral:l(i)},await d().update(I,t,o.ConfigurationTarget.Workspace),o.window.showInformationMessage(`TacSA: Repo rules saved for ${n.name} (workspace).`)}function de(e){let n=o.window.createStatusBarItem(o.StatusBarAlignment.Left,998);n.name="TacSA Branch Sentinel (Tracked repos)",n.command="tacsa-branch-sentinel.pickPinnedRepos",n.show();let t=null,s=null,a=async()=>{let r=await B();if(r.length===0){n.text="\u2387 No Git repo",n.tooltip="TacSA Branch Sentinel: No Git repositories detected.",n.backgroundColor=void 0;return}let i=D(r),l=k(i);ne()?l!==t&&(t=l,await W(l)):t!=="neutral"&&(t="neutral",await W("neutral"));let f=`${i.name}:${i.branch??"DETACHED"}`;if(l==="prod"&&s!==f&&(s=f,o.window.showWarningMessage(`You are on ${i.name} \u2192 ${i.branch}. Be careful.`,"OK")),!r.some(u=>u.name!==i.name)){n.hide();return}n.show();let $=G(),O=$.filter(u=>u!==i.name);if($.length===0){n.text=`${g("list-selection")} select repos`,n.tooltip=`TacSA Branch Sentinel:
Click to select repos to track.
(Active repo is hidden from this display automatically.)`,n.backgroundColor=void 0;return}let v=O.map(u=>r.find(p=>p.name===u)).filter(Boolean);if(v.length===0){n.text=`${g("list-selection")} select repos`,n.tooltip=`TacSA Branch Sentinel:
Nothing to display (your tracked repo is currently active, or not in this workspace).
Click to update selection.`,n.backgroundColor=void 0;return}let C=v.slice(0,2),x=v.length-C.length,U=C.map(u=>{let p=k(u),y=L(p),T=ee(u.name,10),j=u.branch??"DETACHED";return`${y} ${T}\u2022${j}`}),_=x>0?` +${x}`:"";n.text=`+ ${U.join(" | ")}${_}`;let P={prod:5,unknown:4,dev:3,local:2,neutral:1},K=C.map(k).sort((u,p)=>P[p]-P[u])[0];n.backgroundColor=re(K),n.tooltip=v.map(u=>{let p=k(u),y=oe(u.name,u.branch)==="repo-rule"?"rule":"default",T=u.hasRemote?"remote":"local-only";return`${L(p)} ${u.name}: ${u.branch??"DETACHED"} [${y}, ${T}]`}).join(`
`)};e.subscriptions.push(o.commands.registerCommand("tacsa-branch-sentinel.pickPinnedRepos",async()=>{await ie(),await a()}),o.commands.registerCommand("tacsa-branch-sentinel.enableTint",async()=>{await N(!0),t=null,await a(),o.window.showInformationMessage("TacSA: Status bar tint ENABLED (workspace).")}),o.commands.registerCommand("tacsa-branch-sentinel.disableTint",async()=>{await N(!1),t=null,await a(),o.window.showInformationMessage("TacSA: Status bar tint DISABLED (workspace).")}),o.commands.registerCommand("tacsa-branch-sentinel.pickIcons",ce),o.commands.registerCommand("tacsa-branch-sentinel.editRepoRules",ue),o.commands.registerCommand("tacsa-branch-sentinel.markProd",async()=>{let r=await E();r&&(await A("prod",r.repo.name,r.branch),await a())}),o.commands.registerCommand("tacsa-branch-sentinel.markDev",async()=>{let r=await E();r&&(await A("dev",r.repo.name,r.branch),await a())}),o.commands.registerCommand("tacsa-branch-sentinel.markNeutral",async()=>{let r=await E();r&&(await A("neutral",r.repo.name,r.branch),await a())}));let c=setInterval(a,2e3);e.subscriptions.push({dispose:()=>clearInterval(c)}),o.window.onDidChangeActiveTextEditor(a,null,e.subscriptions),o.window.onDidChangeWindowState(a,null,e.subscriptions),a()}function le(){}0&&(module.exports={activate,deactivate});
