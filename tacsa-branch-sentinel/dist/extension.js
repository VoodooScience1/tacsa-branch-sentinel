"use strict";var j=Object.create;var k=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var z=Object.getOwnPropertyNames;var J=Object.getPrototypeOf,Q=Object.prototype.hasOwnProperty;var V=(e,n)=>{for(var t in n)k(e,t,{get:n[t],enumerable:!0})},x=(e,n,t,s)=>{if(n&&typeof n=="object"||typeof n=="function")for(let a of z(n))!Q.call(e,a)&&a!==t&&k(e,a,{get:()=>n[a],enumerable:!(s=q(n,a))||s.enumerable});return e};var Y=(e,n,t)=>(t=e!=null?j(J(e)):{},x(n||!e||!e.__esModule?k(t,"default",{value:e,enumerable:!0}):t,e)),X=e=>x(k({},"__esModule",{value:!0}),e);var le={};V(le,{activate:()=>ue,deactivate:()=>de});module.exports=X(le);var r=Y(require("vscode")),O="tacsaBranchSentinel.enableStatusBarTint",D="tacsaBranchSentinel.repoRules",H="tacsaBranchSentinel.pinnedRepos";function d(){return r.workspace.getConfiguration()}function p(e){return`$(${e})`}function Z(e,n=10){return e.length<=n?e:e.slice(0,n)+"\u2026"}function C(){return d().get(D)??{}}function G(){let e=d().get(H,[]);return Array.isArray(e)?e.filter(Boolean):[]}function ee(){return d().get(O,!0)}async function N(e){await d().update(O,e,r.ConfigurationTarget.Workspace)}function h(e,n){return String(d().get(`tacsaBranchSentinel.${e}`,n)).trim()}function ne(e,n){let t=e.toLowerCase(),s=n.toLowerCase().trim();if(!s)return!1;if(!s.includes("*"))return t===s;let a=s.split("*").filter(Boolean);if(a.length===0)return!0;let c=0;for(let o of a){let i=t.indexOf(o,c);if(i===-1)return!1;c=i+o.length}return!0}function m(e,n){return!e||!n||n.length===0?!1:n.some(t=>ne(e,t))}function te(e,n){let t=C()[e];return!t||!n?"default":m(n,t.prod)||m(n,t.dev)||m(n,t.neutral)?"repo-rule":"default"}function R(e){if(!e.hasRemote)return"local";let n=(e.branch??"").toLowerCase(),t=C()[e.name];if(t&&e.branch){if(m(e.branch,t.prod))return"prod";if(m(e.branch,t.dev))return"dev";if(m(e.branch,t.neutral))return"neutral"}return n==="master"||n==="main"?"prod":n==="dev"?"dev":"unknown"}function L(e){return p(e==="prod"?h("iconProd","shield"):e==="dev"?h("iconDev","tools"):e==="neutral"?h("iconNeutral","git-branch"):e==="local"?"lock":"question")}function oe(e){if(e==="prod")return new r.ThemeColor("statusBarItem.errorBackground");if(e==="unknown")return new r.ThemeColor("statusBarItem.warningBackground");if(e==="dev")return new r.ThemeColor("statusBarItem.prominentBackground")}async function W(e){let n=d().get("workbench.colorCustomizations")??{},t={...n};e==="prod"?(t["statusBar.background"]="#7a1111",t["statusBar.foreground"]="#ffffff",t["statusBar.debuggingBackground"]="#7a1111"):e==="dev"?(t["statusBar.background"]="#0f6b2f",t["statusBar.foreground"]="#ffffff",t["statusBar.debuggingBackground"]="#0f6b2f"):e==="unknown"?(t["statusBar.background"]="#b36b00",t["statusBar.foreground"]="#ffffff",t["statusBar.debuggingBackground"]="#b36b00"):e==="local"?(t["statusBar.background"]="#5b2b82",t["statusBar.foreground"]="#ffffff",t["statusBar.debuggingBackground"]="#5b2b82"):(delete t["statusBar.background"],delete t["statusBar.foreground"],delete t["statusBar.debuggingBackground"]),JSON.stringify(n)!==JSON.stringify(t)&&await d().update("workbench.colorCustomizations",t,r.ConfigurationTarget.Workspace)}function re(e){let n=e.path.split("/").filter(Boolean);return n[n.length-1]??"repo"}async function ae(){let e=r.extensions.getExtension("vscode.git");if(e)return await e.activate(),e.exports.getAPI(1)}async function v(){let e=await ae();return e?e.repositories.map(n=>{let t=re(n.rootUri),s=n.state.HEAD?.name??null,a=n.rootUri.fsPath,c=Array.isArray(n.state.remotes)&&n.state.remotes.length>0;return{name:t,branch:s,path:a,hasRemote:c}}):[]}function B(e){let t=r.window.activeTextEditor?.document?.uri?.fsPath??"";return e.find(s=>t.startsWith(s.path))??e[0]}function A(e){return Array.from(new Set(e))}async function I(e,n,t){let s=C(),a=s[n]??{prod:[],dev:[],neutral:[]},c=t.trim(),o={prod:a.prod??[],dev:a.dev??[],neutral:a.neutral??[]};o.prod=(o.prod??[]).filter(i=>i.toLowerCase()!==c.toLowerCase()),o.dev=(o.dev??[]).filter(i=>i.toLowerCase()!==c.toLowerCase()),o.neutral=(o.neutral??[]).filter(i=>i.toLowerCase()!==c.toLowerCase()),e==="prod"?o.prod=A([...o.prod??[],c]):e==="dev"?o.dev=A([...o.dev??[],c]):o.neutral=A([...o.neutral??[],c]),s[n]=o,await d().update(D,s,r.ConfigurationTarget.Workspace)}async function E(){let e=await v();if(e.length===0)return null;let n=B(e),t=n.branch??"";return t?{repo:n,branch:t}:(r.window.showWarningMessage("TacSA: No branch detected (detached HEAD?)."),null)}async function se(e){let n=await v();if(n.length===0){r.window.showInformationMessage("No Git repositories detected.");return}let t=n.filter(o=>o.name!==e);if(t.length===0){r.window.showInformationMessage("No other repos in this workspace.");return}let s=new Set(G()),a=await r.window.showQuickPick(t.map(o=>({label:o.name,description:o.branch??"DETACHED",detail:o.hasRemote?void 0:"local-only (no remote)",picked:s.has(o.name)})),{canPickMany:!0,placeHolder:"Select OTHER repos to show (active repo is handled by Git/Source Control)"});if(!a)return;let c=a.map(o=>o.label);await d().update(H,c,r.ConfigurationTarget.Workspace),r.window.showInformationMessage(`TacSA: tracking ${c.length} repo(s).`)}async function ie(){let e=["shield","tools","git-branch","beaker","rocket","bug","warning","check","circle-large-outline"],n=async(l,f)=>r.window.showQuickPick(e,{title:`Pick icon for ${l}`,placeHolder:`Current: ${f}`}),t=h("iconProd","shield"),s=h("iconDev","tools"),a=h("iconNeutral","git-branch"),c=await n("PROD",t);if(!c)return;let o=await n("DEV",s);if(!o)return;let i=await n("NEUTRAL",a);i&&(await d().update("tacsaBranchSentinel.iconProd",c,r.ConfigurationTarget.Workspace),await d().update("tacsaBranchSentinel.iconDev",o,r.ConfigurationTarget.Workspace),await d().update("tacsaBranchSentinel.iconNeutral",i,r.ConfigurationTarget.Workspace),r.window.showInformationMessage("TacSA: Icons updated (workspace)."))}async function ce(){let e=await v();if(e.length===0)return;let n=B(e),t=C(),s=t[n.name]??{prod:[],dev:[],neutral:[]},a=async(f,w)=>r.window.showInputBox({title:`Repo rules for ${n.name}`,prompt:`${f} branches (comma-separated, supports * wildcards)`,value:w.join(", ")}),c=await a("PROD",s.prod??[]);if(c===void 0)return;let o=await a("DEV",s.dev??[]);if(o===void 0)return;let i=await a("NEUTRAL",s.neutral??[]);if(i===void 0)return;let l=f=>f.split(",").map(w=>w.trim()).filter(Boolean);t[n.name]={prod:l(c),dev:l(o),neutral:l(i)},await d().update(D,t,r.ConfigurationTarget.Workspace),r.window.showInformationMessage(`TacSA: Repo rules saved for ${n.name} (workspace).`)}function ue(e){let n=r.window.createStatusBarItem(r.StatusBarAlignment.Left,998);n.name="TacSA Branch Sentinel (Other repos)",n.command="tacsa-branch-sentinel.pickPinnedRepos",n.show();let t=null,s=null,a=async()=>{let o=await v();if(o.length===0){n.text="\u2387 No Git repo",n.tooltip="TacSA Branch Sentinel: No Git repositories detected.",n.backgroundColor=void 0;return}let i=B(o),l=R(i);ee()?l!==t&&(t=l,await W(l)):t!=="neutral"&&(t="neutral",await W("neutral"));let f=`${i.name}:${i.branch??"DETACHED"}`;l==="prod"&&s!==f&&(s=f,r.window.showWarningMessage(`You are on ${i.name} \u2192 ${i.branch}. Be careful.`,"OK"));let w=o.filter(u=>u.name!==i.name);if(w.length===0){n.hide();return}n.show();let $=G().filter(u=>u!==i.name);if($.length===0){n.text=`${p("list-selection")} select repos`,n.tooltip=`TacSA Branch Sentinel:
Click to select which OTHER repos to show here.
(Active repo is already shown by Git/Source Control.)`,n.backgroundColor=void 0;return}let b=$.map(u=>w.find(g=>g.name===u)).filter(Boolean);if(b.length===0){n.text=`${p("list-selection")} select repos`,n.tooltip=`TacSA Branch Sentinel:
None of your selected repos are currently present in this workspace.
Click to re-select.`,n.backgroundColor=void 0;return}let y=b.slice(0,2),P=b.length-y.length,F=y.map(u=>{let g=R(u),S=L(g),T=Z(u.name,10),K=u.branch??"DETACHED";return`${S} ${T}\u2022${K}`}),U=P>0?` +${P}`:"";n.text=`+ ${F.join(" | ")}${U}`;let M={prod:5,unknown:4,dev:3,local:2,neutral:1},_=y.map(R).sort((u,g)=>M[g]-M[u])[0];n.backgroundColor=oe(_),n.tooltip=b.map(u=>{let g=R(u),S=te(u.name,u.branch)==="repo-rule"?"rule":"default",T=u.hasRemote?"remote":"local-only";return`${L(g)} ${u.name}: ${u.branch??"DETACHED"} [${S}, ${T}]`}).join(`
`)};e.subscriptions.push(r.commands.registerCommand("tacsa-branch-sentinel.pickPinnedRepos",async()=>{let o=await v();if(o.length===0)return;let i=B(o);await se(i.name),await a()}),r.commands.registerCommand("tacsa-branch-sentinel.enableTint",async()=>{await N(!0),t=null,await a(),r.window.showInformationMessage("TacSA: Status bar tint ENABLED (workspace).")}),r.commands.registerCommand("tacsa-branch-sentinel.disableTint",async()=>{await N(!1),t=null,await a(),r.window.showInformationMessage("TacSA: Status bar tint DISABLED (workspace).")}),r.commands.registerCommand("tacsa-branch-sentinel.pickIcons",ie),r.commands.registerCommand("tacsa-branch-sentinel.editRepoRules",ce),r.commands.registerCommand("tacsa-branch-sentinel.markProd",async()=>{let o=await E();o&&(await I("prod",o.repo.name,o.branch),await a())}),r.commands.registerCommand("tacsa-branch-sentinel.markDev",async()=>{let o=await E();o&&(await I("dev",o.repo.name,o.branch),await a())}),r.commands.registerCommand("tacsa-branch-sentinel.markNeutral",async()=>{let o=await E();o&&(await I("neutral",o.repo.name,o.branch),await a())}));let c=setInterval(a,2e3);e.subscriptions.push({dispose:()=>clearInterval(c)}),r.window.onDidChangeActiveTextEditor(a,null,e.subscriptions),r.window.onDidChangeWindowState(a,null,e.subscriptions),a()}function de(){}0&&(module.exports={activate,deactivate});
